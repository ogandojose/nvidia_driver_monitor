<!DOCTYPE html>
<html>
<head>
    <title>Linux Restricted Modules (L-R-M) Verifier</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{{.CDN.BootstrapCSS}}" rel="stylesheet">
    <link href="{{.CDN.VanillaCSS}}" rel="stylesheet">
    <link href="/static/css/ubuntu-theme.css" rel="stylesheet">
    <style>
        .container-fluid { 
            max-width: 100%; /* Use full width instead of limiting to 1600px */
            font-family: var(--ubuntu-font-family);
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .table-success { 
            background-color: #28a745 !important;
            color: var(--ubuntu-text-bg-2) !important;
        }
        .table-warning { 
            background-color: #ffc107 !important;
            color: var(--ubuntu-text-bg-1) !important;
        }
        .table-danger { 
            background-color: #dc3545 !important;
            color: var(--ubuntu-text-bg-2) !important;
        }
        .badge { 
            font-size: 0.9em;
            font-family: var(--ubuntu-font-family);
        }
        .kernel-table th { 
            background-color: var(--ubuntu-text-bg-4) !important; 
            font-weight: 500;
            color: var(--ubuntu-text-bg-1);
        }
        .last-updated { 
            font-size: 0.9em; 
            color: var(--ubuntu-text-bg-3);
        }
        .sort-icon { 
            font-size: 0.8em; 
            margin-left: 5px; 
            color: #6c757d; 
        }
        th[data-sort]:hover { 
            background-color: #e9ecef !important; 
        }
        .card-header h6 { 
            margin-bottom: 0; 
        }
        
        /* Compact control panel styling */
        .card-body.py-2 {
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
        }
        
        .form-label.mb-1 {
            margin-bottom: 0.25rem !important;
            font-weight: 500;
        }
        
        .form-label.small {
            font-size: 0.8rem;
        }
        
        /* Statistics in header styling */
        .card-header .d-flex {
            font-size: 0.9rem;
        }
        
        .card-header .text-muted.small {
            font-size: 0.8rem;
        }
        
        /* Horizontal filter layout styling */
        .gap-3 {
            gap: 1rem !important;
        }
        
        .vr {
            width: 1px;
            height: 30px;
            background-color: #dee2e6;
        }
        
        .text-nowrap {
            white-space: nowrap;
        }
        
        /* Responsive adjustments for horizontal layout */
        @media (max-width: 1200px) {
            .gap-3 {
                gap: 0.75rem !important;
            }
            
            .form-label.small {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 992px) {
            .d-flex.flex-wrap {
                flex-direction: column;
                align-items: flex-start !important;
            }
            
            .d-flex.align-items-center {
                margin-bottom: 0.5rem;
            }
            
            .vr {
                display: none;
            }
        }
        
        /* Optimize table column widths with fixed layout */
        .kernel-table {
            font-size: 0.875rem; /* Slightly smaller font */
            table-layout: fixed; /* Fixed layout for predictable column widths */
            width: 100%; /* Ensure table uses full available width */
        }
        
        .kernel-table th,
        .kernel-table td {
            padding: 0.4rem; /* Further reduce padding */
            vertical-align: middle;
            overflow: hidden; /* Prevent content overflow */
            text-overflow: ellipsis; /* Add ellipsis for long content */
        }
        
        /* Fixed column widths that guarantee rightmost column visibility */
        .kernel-table th:nth-child(1), /* Series */
        .kernel-table td:nth-child(1) {
            width: 7%;
        }
        
        .kernel-table th:nth-child(2), /* Codename */
        .kernel-table td:nth-child(2) {
            width: 9%;
        }
        
        .kernel-table th:nth-child(3), /* Source & Version */
        .kernel-table td:nth-child(3) {
            width: 16%;
        }
        
        .kernel-table th:nth-child(4), /* Routing */
        .kernel-table td:nth-child(4) {
            width: 7%;
            text-align: center;
        }
        
        .kernel-table th:nth-child(5), /* Supported */
        .kernel-table td:nth-child(5) {
            width: 4%;
            text-align: center;
        }
        
        .kernel-table th:nth-child(6), /* LTS */
        .kernel-table td:nth-child(6) {
            width: 3%;
            text-align: center;
        }
        
        .kernel-table th:nth-child(7), /* ESM */
        .kernel-table td:nth-child(7) {
            width: 3%;
            text-align: center;
        }
        
        .kernel-table th:nth-child(8), /* Development */
        .kernel-table td:nth-child(8) {
            width: 4%;
            text-align: center;
        }
        
        .kernel-table th:nth-child(9), /* L-R-M Package */
        .kernel-table td:nth-child(9) {
            width: 18%;
        }
        
        .kernel-table th:nth-child(10), /* NVIDIA Driver */
        .kernel-table td:nth-child(10) {
            width: 25%; /* Increased from 23% due to space saved from icon columns */
        }
        
        /* Make badges smaller */
        .kernel-table .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* Compact the NVIDIA driver status display */
        .kernel-table .small {
            font-size: 0.7rem;
            line-height: 1.2;
        }
        
        /* Special handling for NVIDIA driver status column */
        .kernel-table td:nth-child(10) {
            width: 23%; /* Larger allocation for the rightmost column */
            overflow: visible; /* Allow content to be fully visible */
        }
        
        .kernel-table td:nth-child(10) .mb-1 {
            margin-bottom: 0.25rem !important;
            font-size: 0.8rem;
        }
        
        .kernel-table td:nth-child(10) .badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
            white-space: nowrap;
        }
        
        /* Ensure the table uses full width and is always fully visible */
        .table-responsive {
            min-height: 400px;
            overflow-x: auto;
            width: 100%;
        }
        
        /* Media query for smaller screens */
        @media (max-width: 1200px) {
            .kernel-table {
                font-size: 0.8rem;
            }
            
            .kernel-table th,
            .kernel-table td {
                padding: 0.3rem;
            }
            
            .kernel-table td:nth-child(10) .badge {
                font-size: 0.6rem;
                padding: 0.15rem 0.3rem;
            }
        }
        
        /* Ensure table never overflows viewport */
        @media (max-width: 992px) {
            .kernel-table {
                font-size: 0.75rem;
            }
            
            .container-fluid {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Linux Restricted Modules (L-R-M) Verifier</h1>
            <a href="/" class="btn btn-secondary"><i class="p-icon--arrow-left"></i> Back to Main</a>
        </div>
        
        <div class="alert alert-info">
            <strong>What this does:</strong> This tool displays kernel L-R-M information for supported NVIDIA driver releases, 
            showing versioning of the kernels and their corresponding linux-restricted-modules packages, 
            and verifies that source files are using the latest DKMS version.
        </div>

        <!-- Compact Filtering, Sorting, and Statistics Controls -->
        <div class="row mb-3">
            <!-- Single Unified Card for Controls and Stats -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-0">Filters & Sorting</h6>
                            </div>
                            <div class="col-md-6">
                                <!-- Inline Statistics -->
                                <div class="d-flex justify-content-end align-items-center">
                                    <div class="me-3">
                                        <strong>{{.Data.TotalKernels}}</strong> Total | 
                                        <strong>{{.Data.SupportedLRM}}</strong> L-R-M | 
                                        <strong id="displayedResultsCount">{{len .Data.KernelResults}}</strong> Displayed
                                    </div>
                                    <div class="text-muted small">
                                        Updated: {{.Data.LastUpdated.Format "15:04:05"}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <!-- Truly Horizontal Layout with Flexbox -->
                        <div class="d-flex flex-wrap align-items-center gap-3">
                            <!-- Primary Filters -->
                            <div class="d-flex align-items-center">
                                <label for="lrmSupportedFilter" class="form-label me-2 mb-0 small text-nowrap"><strong>L-R-M:</strong></label>
                                <select id="lrmSupportedFilter" class="form-select form-select-sm" style="width: auto;">
                                    <option value="all">All</option>
                                    <option value="true" selected>True</option>
                                    <option value="false">False</option>
                                </select>
                            </div>
                            
                            <div class="d-flex align-items-center">
                                <label class="form-label me-2 mb-0 small text-nowrap">Series:</label>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="seriesDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        All
                                    </button>
                                    <div class="dropdown-menu p-2" aria-labelledby="seriesDropdown" id="seriesDropdownMenu" style="max-height: 300px; overflow-y: auto; min-width: 12rem;">
                                        <!-- Series checkboxes will be populated here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex align-items-center">
                                <label for="routingFilter" class="form-label me-2 mb-0 small text-nowrap">Routing:</label>
                                <select id="routingFilter" class="form-select form-select-sm" style="width: auto;">
                                    <option value="">All</option>
                                    <option value="ubuntu/4" selected>ubuntu/4</option>
                                </select>
                            </div>
                            
                            <!-- Separator -->
                            <div class="vr"></div>
                            
                            <!-- Status Filters -->
                            <div class="d-flex align-items-center">
                                <label class="form-label me-2 mb-0 small text-nowrap">Supp:</label>
                                <select id="supportedFilter" class="form-select form-select-sm" style="width: auto;">
                                    <option value="all">All</option>
                                    <option value="true" selected>✓</option>
                                    <option value="false">✗</option>
                                </select>
                            </div>
                            
                            <div class="d-flex align-items-center">
                                <label class="form-label me-2 mb-0 small text-nowrap">LTS:</label>
                                <select id="ltsFilter" class="form-select form-select-sm" style="width: auto;">
                                    <option value="all" selected>All</option>
                                    <option value="true">✓</option>
                                    <option value="false">✗</option>
                                </select>
                            </div>
                            
                            <div class="d-flex align-items-center">
                                <label class="form-label me-2 mb-0 small text-nowrap">ESM:</label>
                                <select id="esmFilter" class="form-select form-select-sm" style="width: auto;">
                                    <option value="all" selected>All</option>
                                    <option value="true">✓</option>
                                    <option value="false">✗</option>
                                </select>
                            </div>
                            
                            <div class="d-flex align-items-center">
                                <label class="form-label me-2 mb-0 small text-nowrap">Dev:</label>
                                <select id="developmentFilter" class="form-select form-select-sm" style="width: auto;">
                                    <option value="all" selected>All</option>
                                    <option value="true">✓</option>
                                    <option value="false">✗</option>
                                </select>
                            </div>
                            
                            <!-- Separator -->
                            <div class="vr"></div>
                            
                            <!-- Sorting -->
                            <div class="d-flex align-items-center">
                                <label for="sortBy" class="form-label me-2 mb-0 small text-nowrap">Sort:</label>
                                <select id="sortBy" class="form-select form-select-sm" style="width: auto;">
                                    <option value="series">Series</option>
                                    <option value="codename">Codename</option>
                                    <option value="source">Source</option>
                                    <option value="supported">Supported</option>
                                    <option value="lts">LTS</option>
                                    <option value="esm">ESM</option>
                                    <option value="development">Development</option>
                                </select>
                            </div>
                            
                            <div class="d-flex align-items-center">
                                <label for="sortOrder" class="form-label me-2 mb-0 small text-nowrap">Order:</label>
                                <select id="sortOrder" class="form-select form-select-sm" style="width: auto;">
                                    <option value="asc">↑</option>
                                    <option value="desc">↓</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {{if .Data.IsInitialized}}
        <!-- Initialized view -->
        {{else}}
        <!-- Initialization progress -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div><strong>Preparing data…</strong></div>
                    <div class="text-muted small"><span id="progressText">0/0</span> (<span id="progressPercent">0</span>%)</div>
                </div>
                <div class="progress" style="height: 20px;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div class="text-muted small mt-2">This page will update automatically. You can navigate away safely.</div>
            </div>
        </div>
        {{end}}

        {{if .Data.KernelResults}}
        <div class="table-responsive">
            <table id="kernelTable" class="table table-striped table-hover kernel-table">
                <thead>
                    <tr>
                        <th data-sort="series">Series <i class="sort-icon"></i></th>
                        <th data-sort="codename">Codename <i class="sort-icon"></i></th>
                        <th data-sort="source">Source & Version <i class="sort-icon"></i></th>
                        <th data-sort="routing">Routing <i class="sort-icon"></i></th>
                        <th data-sort="supported">Supp. <i class="sort-icon"></i></th>
                        <th data-sort="lts">LTS <i class="sort-icon"></i></th>
                        <th data-sort="esm">ESM <i class="sort-icon"></i></th>
                        <th data-sort="development">Dev. <i class="sort-icon"></i></th>
                        <th>L-R-M Package</th>
                        <th>NVIDIA Driver & Status</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Data.KernelResults}}
                    <tr>
                        <td><strong>{{.Series}}</strong></td>
                        <td>{{.Codename}}</td>
                        <td>
                            <div><code>{{.Source}}</code></div>
                            {{if and (ne .SourceVersion "N/A") (ne .SourceVersion "ERROR")}}
                            <div class="small text-muted">{{.SourceVersion}}</div>
                            {{else}}
                            <div class="small text-muted">{{.SourceVersion}}</div>
                            {{end}}
                        </td>
                        <td><span class="badge bg-secondary">{{.Routing}}</span></td>
                        <td>
                            {{if .Supported}}
                            <span class="badge bg-success">✓</span>
                            {{else}}
                            <span class="badge bg-danger">✗</span>
                            {{end}}
                        </td>
                        <td>
                            {{if .LTS}}
                            <span class="badge bg-primary">✓</span>
                            {{else}}
                            <span class="text-muted">-</span>
                            {{end}}
                        </td>
                        <td>
                            {{if .ESM}}
                            <span class="badge bg-secondary">✓</span>
                            {{else}}
                            <span class="text-muted">-</span>
                            {{end}}
                        </td>
                        <td>
                            {{if .Development}}
                            <span class="badge bg-info">✓</span>
                            {{else}}
                            <span class="text-muted">-</span>
                            {{end}}
                        </td>
                        <td>
                            {{range .LRMPackages}}
                            <div><code>{{.}}</code></div>
                            {{end}}
                            {{if and (ne .LatestLRMVersion "N/A") (ne .LatestLRMVersion "ERROR")}}
                            <div class="small text-muted">{{.LatestLRMVersion}}</div>
                            {{else}}
                            <div class="small text-muted">{{.LatestLRMVersion}}</div>
                            {{end}}
                        </td>
                        <td>
                            {{range .NvidiaDriverStatuses}}
                            <div class="mb-1 d-flex align-items-center justify-content-between">
                                <div>
                                    <div><strong>{{simplifyDriverName .DriverName}}</strong></div>
                                    <div class="small text-muted">DSC: {{.DSCVersion}}</div>
                                    {{if .DKMSVersion}}
                                    <div class="small text-muted">DKMS: {{.DKMSVersion}}</div>
                                    {{end}}
                                </div>
                                <div class="ms-2">
                                    {{if contains .Status "Up to date"}}
                                    <span class="badge bg-success"><i class="p-icon--success"></i> {{.Status}}</span>
                                    {{else if contains .Status "Update available"}}
                                    <span class="badge bg-warning"><i class="p-icon--restart"></i> {{.Status}}</span>
                                    {{else if contains .Status "Unknown"}}
                                    <span class="badge bg-secondary"><i class="p-icon--warning"></i> {{.Status}}</span>
                                    {{else}}
                                    <span class="badge bg-secondary"><i class="p-icon--information"></i> {{.Status}}</span>
                                    {{end}}
                                </div>
                            </div>
                            {{end}}
                            {{if not .NvidiaDriverStatuses}}
                            <span class="text-muted">N/A</span>
                            {{end}}
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{else}}
        <div class="alert alert-warning">
            <h4>No kernel sources found matching the criteria.</h4>
            <p>Try changing the routing filter or check if the kernel-series.yaml data is available.</p>
        </div>
        {{end}}

        <div class="mt-4">
            <div class="last-updated">
                Data generated from supported releases at {{.Data.LastUpdated.Format "2006-01-02 15:04:05 MST"}}
            </div>
        </div>
    </div>

    <script src="{{.CDN.BootstrapJS}}"></script>
    <script>
        // Table filtering and sorting functionality
        let originalData = [];
        let currentData = [];
        let refreshInterval = null;
        let lastRefreshTime = null;
        const REFRESH_INTERVAL_MS = 10 * 60 * 1000; // 10 minutes in milliseconds

        // Function to simplify NVIDIA driver names (matches Go template function)
        function simplifyDriverName(driverName) {
            const prefix = "nvidia-graphics-drivers-";
            if (driverName && driverName.startsWith(prefix)) {
                return driverName.substring(prefix.length);
            }
            return driverName;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Fetch data from API instead of parsing HTML table
            fetchKernelData();
            
            // Start automatic refresh
            startAutoRefresh();
        });

        async function fetchKernelData() {
            try {
                const response = await fetch('/api/lrm');
                const data = await response.json();
                
                // Store original data from API
                originalData = data.data.kernel_results.map(kernel => {
                    return {
                        ...kernel,
                        element: null, // Will be populated when rendering table
                        hasLRM: kernel.HasLRM,
                        supported: kernel.Supported,
                        development: kernel.Development,
                        lts: kernel.LTS,
                        esm: kernel.ESM
                    };
                });
                
                currentData = [...originalData];
                
                // Populate filter dropdowns
                populateSeriesFilter();
                populateRoutingFilter();
                
                // Add event listeners for all filters
                document.getElementById('lrmSupportedFilter').addEventListener('change', handleLrmFilterChange);
                // Series multi-select handled via checkbox events; listeners are attached on populate
                document.getElementById('routingFilter').addEventListener('change', handleOtherFilterChange);
                
                // Status dropdown event listeners
                document.getElementById('supportedFilter').addEventListener('change', handleOtherFilterChange);
                document.getElementById('ltsFilter').addEventListener('change', handleOtherFilterChange);
                document.getElementById('esmFilter').addEventListener('change', handleOtherFilterChange);
                document.getElementById('developmentFilter').addEventListener('change', handleOtherFilterChange);
                
                document.getElementById('sortBy').addEventListener('change', applySorting);
                document.getElementById('sortOrder').addEventListener('change', applySorting);
                
                // Add click handlers for column headers
                document.querySelectorAll('th[data-sort]').forEach(header => {
                    header.style.cursor = 'pointer';
                    header.addEventListener('click', function() {
                        const sortBy = this.getAttribute('data-sort');
                        document.getElementById('sortBy').value = sortBy;
                        applySorting();
                    });
                });
                
                // Apply initial filtering
                applyFilters();
            } catch (error) {
                console.error('Error fetching kernel data:', error);
                // Fallback to HTML table parsing if API fails
                fallbackToTableParsing();
            }
        }

        function fallbackToTableParsing() {
            // Store original table data as fallback
            const tableBody = document.querySelector('#kernelTable tbody');
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            
            originalData = rows.map(row => ({
                element: row.cloneNode(true),
                Series: row.cells[0].textContent.trim(),
                Codename: row.cells[1].textContent.trim(),
                Source: row.cells[2].textContent.trim(),
                Routing: row.cells[3].textContent.trim(),
                hasLRM: row.cells[8].textContent.trim() !== 'N/A' && row.cells[8].textContent.trim() !== '',
                HasLRM: row.cells[8].textContent.trim() !== 'N/A' && row.cells[8].textContent.trim() !== '',
                // Parse status badges from individual columns
                supported: row.cells[4].innerHTML.includes('✓'),
                Supported: row.cells[4].innerHTML.includes('✓'),
                development: row.cells[7].innerHTML.includes('✓'),
                Development: row.cells[7].innerHTML.includes('✓'),
                lts: row.cells[5].innerHTML.includes('✓'),
                LTS: row.cells[5].innerHTML.includes('✓'),
                esm: row.cells[6].innerHTML.includes('✓'),
                ESM: row.cells[6].innerHTML.includes('✓'),
                // Extract LRM package information
                LRMPackages: row.cells[8].innerHTML.includes('<code>') ? 
                    Array.from(row.cells[8].querySelectorAll('code')).map(code => code.textContent) : [],
                LatestLRMVersion: row.cells[8].querySelector('.text-muted') ? 
                    row.cells[8].querySelector('.text-muted').textContent.trim() : 'N/A',
                // Extract NVIDIA driver information from original HTML
                nvidiaDriverHTML: row.cells[9].innerHTML
            }));
            
            currentData = [...originalData];
            
            // Populate filter dropdowns
            populateSeriesFilter();
            populateRoutingFilter();
            
            // Add event listeners
            document.getElementById('lrmSupportedFilter').addEventListener('change', handleLrmFilterChange);
            // Series multi-select handled via checkbox events; listeners are attached on populate
            document.getElementById('routingFilter').addEventListener('change', handleOtherFilterChange);
            
            // Status dropdown event listeners
            document.getElementById('supportedFilter').addEventListener('change', handleOtherFilterChange);
            document.getElementById('ltsFilter').addEventListener('change', handleOtherFilterChange);
            document.getElementById('esmFilter').addEventListener('change', handleOtherFilterChange);
            document.getElementById('developmentFilter').addEventListener('change', handleOtherFilterChange);
            
            document.getElementById('sortBy').addEventListener('change', applySorting);
            document.getElementById('sortOrder').addEventListener('change', applySorting);
            
            // Add click handlers for column headers
            document.querySelectorAll('th[data-sort]').forEach(header => {
                header.style.cursor = 'pointer';
                header.addEventListener('click', function() {
                    const sortBy = this.getAttribute('data-sort');
                    document.getElementById('sortBy').value = sortBy;
                    applySorting();
                });
            });
            
            // Apply initial filtering
            applyFilters();
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            // Update refresh status
            updateRefreshStatus();
            
            // Set up interval for automatic refresh
            refreshInterval = setInterval(() => {
                refreshDataInBackground();
            }, REFRESH_INTERVAL_MS);
            
            console.log('Auto-refresh started: data will refresh every 10 minutes');
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                console.log('Auto-refresh stopped');
            }
        }

        async function refreshDataInBackground() {
            console.log('Refreshing LRM data in background...');
            
            try {
                // Store current filter and sort settings
                const currentFilters = {
                    lrmSupported: document.getElementById('lrmSupportedFilter').value,
                    series: document.getElementById('seriesFilter').value,
                    routing: document.getElementById('routingFilter').value,
                    supported: document.getElementById('supportedFilter').value,
                    lts: document.getElementById('ltsFilter').value,
                    esm: document.getElementById('esmFilter').value,
                    development: document.getElementById('developmentFilter').value,
                    sortBy: document.getElementById('sortBy').value,
                    sortOrder: document.getElementById('sortOrder').value
                };

                // Fetch new data
                const response = await fetch('/api/lrm');
                const data = await response.json();
                
                // Update data arrays
                originalData = data.data.kernel_results.map(kernel => {
                    return {
                        ...kernel,
                        element: null,
                        hasLRM: kernel.HasLRM,
                        supported: kernel.Supported,
                        development: kernel.Development,
                        lts: kernel.LTS,
                        esm: kernel.ESM
                    };
                });
                
                currentData = [...originalData];
                
                // Restore filter and sort settings
                Object.keys(currentFilters).forEach(key => {
                    const element = document.getElementById(key === 'lrmSupported' ? 'lrmSupportedFilter' : 
                                                         key === 'sortBy' ? 'sortBy' :
                                                         key === 'sortOrder' ? 'sortOrder' :
                                                         key + 'Filter');
                    if (element) {
                        element.value = currentFilters[key];
                    }
                });
                
                // Repopulate filter dropdowns (in case new options were added)
                populateSeriesFilter();
                populateRoutingFilter();
                
                // Reapply filters and sorting
                applyFilters();
                applySorting();
                
                // Update refresh status
                lastRefreshTime = new Date();
                updateRefreshStatus();
                
                console.log('Background refresh completed successfully');
                
            } catch (error) {
                console.error('Background refresh failed:', error);
                // Don't stop auto-refresh on error, just log it
            }
        }

        function updateRefreshStatus() {
            lastRefreshTime = lastRefreshTime || new Date();
            
            // Find or create refresh status element
            let statusElement = document.getElementById('refresh-status');
            if (!statusElement) {
                // Create refresh status element
                statusElement = document.createElement('div');
                statusElement.id = 'refresh-status';
                statusElement.className = 'text-muted small mb-2';
                statusElement.style.fontSize = '0.85em';
                
                // Insert it before the table
                const table = document.getElementById('kernelTable');
                if (table) {
                    table.parentNode.insertBefore(statusElement, table);
                }
            }
            
            const timeString = lastRefreshTime.toLocaleTimeString();
            statusElement.innerHTML = `
                <i class="fas fa-sync-alt"></i> 
                Last updated: ${timeString} | 
                Auto-refresh: every 10 minutes | 
                <a href="#" onclick="refreshDataInBackground(); return false;" style="text-decoration: none;">
                    <i class="fas fa-redo"></i> Refresh now
                </a>
            `;
        }

        // Manage selected series in a Set
        let selectedSeries = new Set();

        function parseSeriesNumeric(s) {
            // Expect formats like "25.10", "24.04"; fallback returns null
            if (!s || typeof s !== 'string') return null;
            const m = s.match(/^(\d{2})\.(\d{2})/);
            if (!m) return null;
            return { major: parseInt(m[1], 10), minor: parseInt(m[2], 10) };
        }

        function populateSeriesFilter() {
            const seriesSet = new Set();
            originalData.forEach(item => seriesSet.add(item.Series || item.series));
            const seriesList = Array.from(seriesSet);

            // Sort by number.number descending (major desc, then minor desc); non-matching last
            seriesList.sort((a, b) => {
                const pa = parseSeriesNumeric(a);
                const pb = parseSeriesNumeric(b);
                if (pa && pb) {
                    if (pa.major !== pb.major) return pb.major - pa.major;
                    return pb.minor - pa.minor;
                }
                if (pa && !pb) return -1; // numeric first
                if (!pa && pb) return 1;
                return (b || '').localeCompare(a || '');
            });

            const menu = document.getElementById('seriesDropdownMenu');
            menu.innerHTML = '';

            // Add helper actions
            const actions = document.createElement('div');
            actions.className = 'd-flex justify-content-between align-items-center mb-2';
            actions.innerHTML = `
                <button type="button" class="btn btn-sm btn-link p-0" id="seriesSelectAll">Select all</button>
                <button type="button" class="btn btn-sm btn-link p-0" id="seriesClearAll">Clear all</button>
            `;
            menu.appendChild(actions);

            // Create checkbox items
            seriesList.forEach(series => {
                const id = `series-${series.replace(/[^a-zA-Z0-9_.-]/g, '_')}`;
                const wrapper = document.createElement('div');
                wrapper.className = 'form-check';
                wrapper.innerHTML = `
                    <input class="form-check-input series-option" type="checkbox" value="${series}" id="${id}">
                    <label class="form-check-label" for="${id}">${series}</label>
                `;
                menu.appendChild(wrapper);
            });

            // Attach listeners
            menu.querySelectorAll('.series-option').forEach(cb => {
                cb.addEventListener('change', () => {
                    if (cb.checked) {
                        selectedSeries.add(cb.value);
                    } else {
                        selectedSeries.delete(cb.value);
                    }
                    updateSeriesDropdownLabel();
                    applyFilters();
                });
            });

            const selectAllBtn = document.getElementById('seriesSelectAll');
            const clearAllBtn = document.getElementById('seriesClearAll');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', () => {
                    selectedSeries = new Set(seriesList);
                    menu.querySelectorAll('.series-option').forEach(cb => { cb.checked = true; });
                    updateSeriesDropdownLabel();
                    applyFilters();
                });
            }
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', () => {
                    selectedSeries.clear();
                    menu.querySelectorAll('.series-option').forEach(cb => { cb.checked = false; });
                    updateSeriesDropdownLabel();
                    applyFilters();
                });
            }

            // Restore selections if any
            if (selectedSeries.size > 0) {
                menu.querySelectorAll('.series-option').forEach(cb => {
                    cb.checked = selectedSeries.has(cb.value);
                });
            }
            updateSeriesDropdownLabel();
        }

        function updateSeriesDropdownLabel() {
            const btn = document.getElementById('seriesDropdown');
            if (!btn) return;
            if (selectedSeries.size === 0) {
                btn.textContent = 'All';
            } else if (selectedSeries.size <= 3) {
                btn.textContent = Array.from(selectedSeries).sort().join(', ');
            } else {
                btn.textContent = `${selectedSeries.size} selected`;
            }
        }

        function populateRoutingFilter() {
            const routingSet = new Set();
            originalData.forEach(item => routingSet.add(item.Routing || item.routing));
            
            const routingFilter = document.getElementById('routingFilter');
            // Keep the current selected value
            const currentValue = routingFilter.value;
            
            routingSet.forEach(routing => {
                // Skip if option already exists
                if (!Array.from(routingFilter.options).some(option => option.value === routing)) {
                    const option = document.createElement('option');
                    option.value = routing;
                    option.textContent = routing;
                    routingFilter.appendChild(option);
                }
            });
            
            // Restore the selected value (ubuntu/4 by default)
            routingFilter.value = currentValue;
        }

        function handleLrmFilterChange() {
            const lrmFilter = document.getElementById('lrmSupportedFilter').value;
            
            // Only reset filters when switching to 'all' LRM view
            if (lrmFilter === 'all') {
                // When LRM filter is set to 'all', reset other filters to defaults for clarity
                selectedSeries.clear();
                // Uncheck all series options
                const menu = document.getElementById('seriesDropdownMenu');
                if (menu) menu.querySelectorAll('.series-option').forEach(cb => { cb.checked = false; });
                updateSeriesDropdownLabel();
                document.getElementById('supportedFilter').value = 'true';
                document.getElementById('ltsFilter').value = 'all';
                document.getElementById('esmFilter').value = 'all';
                document.getElementById('developmentFilter').value = 'all';
            }
            
            applyFilters();
        }
        
        function handleOtherFilterChange() {
            // When any other filter is changed, just apply the current filter values
            applyFilters();
        }

        function applyFilters() {
            const lrmSupportedFilter = document.getElementById('lrmSupportedFilter').value;
            const seriesSelected = Array.from(selectedSeries);
            const routingFilter = document.getElementById('routingFilter').value;
            
            // Get status filter dropdown values
            const supportedFilter = document.getElementById('supportedFilter').value;
            const ltsFilter = document.getElementById('ltsFilter').value;
            const esmFilter = document.getElementById('esmFilter').value;
            const developmentFilter = document.getElementById('developmentFilter').value;
            
            currentData = originalData.filter(item => {
                let matches = true;
                
                // Apply LRM filter
                if (lrmSupportedFilter !== 'all') {
                    const hasLRM = item.hasLRM || item.HasLRM;
                    if (lrmSupportedFilter === 'true' && !hasLRM) {
                        matches = false;
                    }
                    if (lrmSupportedFilter === 'false' && hasLRM) {
                        matches = false;
                    }
                }
                
                // Apply series filter (multiple allowed); if none selected, treat as All
                if (seriesSelected.length > 0) {
                    const val = (item.Series || item.series);
                    if (!seriesSelected.includes(val)) {
                        matches = false;
                    }
                }
                
                // Apply routing filter
                if (routingFilter && (item.Routing || item.routing) !== routingFilter) {
                    matches = false;
                }
                
                // Apply status filters based on dropdown selections
                
                // Apply Supported filter
                if (supportedFilter !== 'all') {
                    const isSupported = item.supported || item.Supported;
                    if (supportedFilter === 'true' && !isSupported) {
                        matches = false;
                    }
                    if (supportedFilter === 'false' && isSupported) {
                        matches = false;
                    }
                }
                
                // Apply LTS filter
                if (ltsFilter !== 'all') {
                    const isLTS = item.lts || item.LTS;
                    if (ltsFilter === 'true' && !isLTS) {
                        matches = false;
                    }
                    if (ltsFilter === 'false' && isLTS) {
                        matches = false;
                    }
                }
                
                // Apply ESM filter
                if (esmFilter !== 'all') {
                    const isESM = item.esm || item.ESM;
                    if (esmFilter === 'true' && !isESM) {
                        matches = false;
                    }
                    if (esmFilter === 'false' && isESM) {
                        matches = false;
                    }
                }
                
                // Apply Development filter
                if (developmentFilter !== 'all') {
                    const isDevelopment = item.development || item.Development;
                    if (developmentFilter === 'true' && !isDevelopment) {
                        matches = false;
                    }
                    if (developmentFilter === 'false' && isDevelopment) {
                        matches = false;
                    }
                }
                
                return matches;
            });
            
            applySorting();
        }

        function applySorting() {
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            currentData.sort((a, b) => {
                let valueA = '';
                let valueB = '';
                
                // Map sort fields to correct API field names
                switch(sortBy) {
                    case 'series':
                        valueA = a.Series || a.series || '';
                        valueB = b.Series || b.series || '';
                        break;
                    case 'codename':
                        valueA = a.Codename || a.codename || '';
                        valueB = b.Codename || b.codename || '';
                        break;
                    case 'source':
                        valueA = a.Source || a.source || '';
                        valueB = b.Source || b.source || '';
                        break;
                    case 'routing':
                        valueA = a.Routing || a.routing || '';
                        valueB = b.Routing || b.routing || '';
                        break;
                    case 'supported':
                        valueA = (a.Supported || a.supported) ? 1 : 0;
                        valueB = (b.Supported || b.supported) ? 1 : 0;
                        break;
                    case 'lts':
                        valueA = (a.LTS || a.lts) ? 1 : 0;
                        valueB = (b.LTS || b.lts) ? 1 : 0;
                        break;
                    case 'esm':
                        valueA = (a.ESM || a.esm) ? 1 : 0;
                        valueB = (b.ESM || b.esm) ? 1 : 0;
                        break;
                    case 'development':
                        valueA = (a.Development || a.development) ? 1 : 0;
                        valueB = (b.Development || b.development) ? 1 : 0;
                        break;
                    default:
                        valueA = a[sortBy] || '';
                        valueB = b[sortBy] || '';
                }
                
                // Convert to lowercase for case-insensitive sorting (except for numeric values)
                if (typeof valueA === 'string') valueA = valueA.toLowerCase();
                if (typeof valueB === 'string') valueB = valueB.toLowerCase();
                
                let comparison;
                if (typeof valueA === 'number' && typeof valueB === 'number') {
                    comparison = valueA - valueB;
                } else {
                    comparison = valueA.toString().localeCompare(valueB.toString());
                }
                
                return sortOrder === 'desc' ? -comparison : comparison;
            });
            
            updateTable();
        }

        function updateTable() {
            const tableBody = document.querySelector('#kernelTable tbody');
            tableBody.innerHTML = '';
            
            currentData.forEach(item => {
                if (item.element) {
                    // Use cloned element if available (fallback mode)
                    tableBody.appendChild(item.element.cloneNode(true));
                } else {
                    // Create new row from API data
                    const row = document.createElement('tr');
                    
                    // Series
                    const seriesCell = document.createElement('td');
                    seriesCell.innerHTML = `<strong>${item.Series || ''}</strong>`;
                    row.appendChild(seriesCell);
                    
                    // Codename
                    const codenameCell = document.createElement('td');
                    codenameCell.textContent = item.Codename || '';
                    row.appendChild(codenameCell);
                    
                    // Source & Version
                    const sourceCell = document.createElement('td');
                    const sourceHTML = `<div><code>${item.Source || ''}</code></div>`;
                    const versionHTML = item.SourceVersion && item.SourceVersion !== 'N/A' && item.SourceVersion !== 'ERROR' 
                        ? `<div class="small text-muted">${item.SourceVersion}</div>`
                        : `<div class="small text-muted">${item.SourceVersion || 'N/A'}</div>`;
                    sourceCell.innerHTML = sourceHTML + versionHTML;
                    row.appendChild(sourceCell);
                    
                    // Routing
                    const routingCell = document.createElement('td');
                    routingCell.innerHTML = `<span class="badge bg-secondary">${item.Routing || ''}</span>`;
                    row.appendChild(routingCell);
                    
                    // Supported Status
                    const supportedCell = document.createElement('td');
                    if (item.Supported) {
                        supportedCell.innerHTML = '<span class="badge bg-success">✓</span>';
                    } else {
                        supportedCell.innerHTML = '<span class="badge bg-danger">✗</span>';
                    }
                    row.appendChild(supportedCell);
                    
                    // LTS Status
                    const ltsCell = document.createElement('td');
                    if (item.LTS) {
                        ltsCell.innerHTML = '<span class="badge bg-primary">✓</span>';
                    } else {
                        ltsCell.innerHTML = '<span class="text-muted">-</span>';
                    }
                    row.appendChild(ltsCell);
                    
                    // ESM Status
                    const esmCell = document.createElement('td');
                    if (item.ESM) {
                        esmCell.innerHTML = '<span class="badge bg-secondary">✓</span>';
                    } else {
                        esmCell.innerHTML = '<span class="text-muted">-</span>';
                    }
                    row.appendChild(esmCell);
                    
                    // Development Status
                    const developmentCell = document.createElement('td');
                    if (item.Development) {
                        developmentCell.innerHTML = '<span class="badge bg-info">✓</span>';
                    } else {
                        developmentCell.innerHTML = '<span class="text-muted">-</span>';
                    }
                    row.appendChild(developmentCell);
                    
                    // L-R-M Package & Version
                    const lrmCell = document.createElement('td');
                    if (item.nvidiaDriverHTML) {
                        // Use preserved HTML for LRM in fallback mode
                        lrmCell.innerHTML = item.element.cells[8].innerHTML;
                    } else if (item.LRMPackages && item.LRMPackages.length > 0) {
                        const packageHTML = item.LRMPackages.map(pkg => `<div><code>${pkg}</code></div>`).join('');
                        const versionHTML = item.LatestLRMVersion && item.LatestLRMVersion !== 'N/A' && item.LatestLRMVersion !== 'ERROR'
                            ? `<div class="small text-muted">${item.LatestLRMVersion}</div>`
                            : `<div class="small text-muted">${item.LatestLRMVersion || 'N/A'}</div>`;
                        lrmCell.innerHTML = packageHTML + versionHTML;
                    } else {
                        lrmCell.innerHTML = '<span class="text-muted">N/A</span>';
                    }
                    row.appendChild(lrmCell);
                    
                    // NVIDIA Driver & Status (Combined: Driver name, DSC version, DKMS version, and status badge)
                    const nvidiaDriverCell = document.createElement('td');
                    if (item.nvidiaDriverHTML) {
                        // Use preserved HTML from original table in fallback mode
                        nvidiaDriverCell.innerHTML = item.nvidiaDriverHTML;
                    } else if (item.NvidiaDriverStatuses && item.NvidiaDriverStatuses.length > 0) {
                        const driverHTML = item.NvidiaDriverStatuses.map(driver => {
                            let badgeClass = 'bg-secondary';
                            let iconClass = 'p-icon--information';
                            if (driver.Status && driver.Status.includes('Up to date')) {
                                badgeClass = 'bg-success';
                                iconClass = 'p-icon--success';
                            } else if (driver.Status && driver.Status.includes('Update available')) {
                                badgeClass = 'bg-warning';
                                iconClass = 'p-icon--restart';
                            }
                            
                            let html = `<div class="mb-1 d-flex align-items-center justify-content-between">`;
                            html += `<div>`;
                            html += `<div><strong>${simplifyDriverName(driver.DriverName) || 'Unknown Driver'}</strong></div>`;
                            html += `<div class="small text-muted">DSC: ${driver.DSCVersion || 'N/A'}</div>`;
                            if (driver.DKMSVersion) {
                                html += `<div class="small text-muted">DKMS: ${driver.DKMSVersion}</div>`;
                            }
                            html += `</div>`;
                            html += `<div class="ms-2">`;
                            html += `<span class="badge ${badgeClass}"><i class="${iconClass}"></i> ${driver.Status || 'Unknown'}</span>`;
                            html += `</div>`;
                            html += `</div>`;
                            return html;
                        }).join('');
                        nvidiaDriverCell.innerHTML = driverHTML;
                    } else {
                        nvidiaDriverCell.innerHTML = '<span class="text-muted">N/A</span>';
                    }
                    row.appendChild(nvidiaDriverCell);
                    
                    tableBody.appendChild(row);
                }
            });
            
            // Update the displayed results count
            document.getElementById('displayedResultsCount').textContent = currentData.length;
            
            // Update sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.textContent = '';
            });
            
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;
            const activeHeader = document.querySelector(`th[data-sort="${sortBy}"] .sort-icon`);
            
            if (activeHeader) {
                activeHeader.textContent = sortOrder === 'asc' ? '↑' : '↓';
            }
        }
        // Progress polling logic (only runs if progress bar exists)
        document.addEventListener('DOMContentLoaded', function() {
            const bar = document.getElementById('progressBar');
            const txt = document.getElementById('progressText');
            const pct = document.getElementById('progressPercent');
            if (!bar || !txt || !pct) return;

            async function poll() {
                try {
                    const res = await fetch('/api/lrm/progress', { cache: 'no-store' });
                    if (!res.ok) throw new Error('progress fetch failed');
                    const data = await res.json();
                    const total = data.total || 0;
                    const completed = data.completed || 0;
                    const percent = Math.min(100, Math.floor(data.percent || (total ? (completed/total*100) : 0)));
                    txt.textContent = `${completed}/${total}`;
                    pct.textContent = `${percent}`;
                    bar.style.width = `${percent}%`;
                    bar.setAttribute('aria-valuenow', String(percent));
                    bar.textContent = `${percent}%`;

                    // If initialized is true and percent is 100, reload to show full table
                    if (data.initialized || percent >= 100) {
                        setTimeout(() => window.location.reload(), 800);
                        return;
                    }
                } catch (e) {
                    // best-effort; keep polling
                } finally {
                    setTimeout(poll, 1000);
                }
            }

            poll();
        });
    </script>
</body>
</html>
